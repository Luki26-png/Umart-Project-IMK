doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(http-equiv="X-UA-Compatible", content="IE=edge")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="public/styles/navbar.css")
    link(rel="stylesheet", href="public/styles/footer.css")
    link(rel="stylesheet", href="public/styles/global.css")
    title Profile
    style.
      @media screen and (max-width:767px) {
        #ubah-foto-container {
          padding: 1em 0em !important;
        }
      }

  body
    include ../navbar.pug
    main.container-fluid.px-5.my-5.d-flex.flex-wrap.justify-content-center
      .w-75
        h2 Edit Profile
        hr.w-50(style="background-color: #000000;")
        h5.fw-medium Foto
        .card.mb-3.border-0(style="max-width: 800px;")
          .row.g-0
            .col-md-4
              if avatar 
                img.img-fluid.rounded-start(id='profile-picture', style='width:600px;max-height:auto;', src=`public/user_avatar/${avatar}`, alt="your profile picture")
              else 
                img.img-fluid.rounded-start( id='profile-picture',style='width:600px;max-height:auto;', src="https://imageplaceholder.net/600", alt="your profile picture")
            .col-md-8
              #ubah-foto-container.card-body.py-0.h-100.d-flex.flex-column.flex-wrap.justify-content-end
                label.form-label.fw-bold(for="img-file") Ubah Profile
                input#uploaded-profile.form-control(type="file")

        form
          .mb-3
            label.form-label.fw-bold(for="username") Username
            input#username.form-control(type="text", placeholder= fullName, value = fullName)
          .mb-3
            label.form-label.fw-bold(for="no-hp") No.hp
            if phone
              input#no-hp.form-control(type="text", placeholder= phone, value = phone)
            else 
              input#no-hp.form-control(type="text", placeholder="Masukkan Nomor Telepon Anda")
          .mb-3
            label.form-label.fw-bold(for="alamat") Alamat
            if address 
              input#alamat.form-control(type="text", placeholder= address, value = address)
            else 
              input#alamat.form-control(type="text", placeholder= "Masukkan Alamat Anda")

        .btn-group.w-100(role="group", aria-label="profile-button")
          button.btn.btn-warning.background-kuning.me-3.rounded-1(type="button", id='riset-profile-button') Riset
          button.btn.btn-primary.background-biru-laut.ms-3.rounded-1(type="button", id='simpan-profile-button') Simpan
    
    // Modal for success message
    #successModal.modal.fade(tabindex="-1", aria-labelledby="successModalLabel", aria-hidden="true")
      .modal-dialog.modal-dialog-centered
        .modal-content
          .modal-header
            h5#successModalLabel.modal-title Update Berhasil
            button.btn-close(type="button", data-bs-dismiss="modal", aria-label="Close")
          .modal-body
            p Profil Anda telah berhasil diperbarui.
          .modal-footer
            button.btn.btn-primary(type="button", data-bs-dismiss="modal") Tutup


    include ../footer.pug
    
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script.
        document.getElementById('uploaded-profile').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const previewImage = document.getElementById('profile-picture');
                previewImage.src = e.target.result;
            };
            reader.readAsDataURL(file); // Reads file as base64 URL
        });

        document.getElementById('simpan-profile-button').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData();

            // Grab values and trim
            const username = document.getElementById('username').value.trim();
            const phone = document.getElementById('no-hp').value.trim();
            const address = document.getElementById('alamat').value.trim();
            const fileInput = document.getElementById('uploaded-profile');

            // Track how many fields actually have values
            let hasData = false;

            if (username) {
              formData.append('name', username);
              hasData = true;
            }

            if (phone) {
              formData.append('phone_number', phone);
              hasData = true;
            }

            if (address) {
              formData.append('address', address);
              hasData = true;
            }

            if (fileInput.files.length > 0) {
              formData.append('profile_picture', fileInput.files[0]);
              hasData = true;
            }

            // Don't send if no data at all
            if (!hasData) {
              alert('Tidak ada data yang diisi. Form tidak dikirim.');
              return;
            }

            // Send to server
            fetch('/user/profile', {
              method: 'PUT',
              body: formData
            })
            .then(response => {
              if (!response.ok) throw new Error('Terjadi kesalahan pada server');
              return response.json(); // Or .text() if your server doesn't return JSON
            })
            .then(data => {
              // Show the success modal
              const successModal = new bootstrap.Modal(document.getElementById('successModal'));
              successModal.show();
              console.log(data);
            })
            .catch(error => {
              alert('Gagal mengirim data: ' + error.message);
            });
        });
    
        document.getElementById('riset-profile-button').addEventListener('click', function (event) {
            event.preventDefault();
            const username = document.getElementById('username');
            const phone = document.getElementById('no-hp');
            const address = document.getElementById('alamat');
            username.value = username.placeholder === "Masukkan Nama Lengkap Anda" ? "" : username.placeholder;
            phone.value = phone.placeholder === "Masukkan Nomor Telepon Anda" ? "" : phone.placeholder;
            address.value = address.placeholder === "Masukkan Alamat Anda" ? "" : address.placeholder;
        });

        // Add event listener for when the modal is hidden
        const successModalElement = document.getElementById('successModal');
        successModalElement.addEventListener('hidden.bs.modal', function () {
            window.location.reload();
        });